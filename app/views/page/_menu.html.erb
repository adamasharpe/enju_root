<div id="navibar">
  <%- cache(:controller => 'page', :user => current_user.try(:username), :menu => 'search', :locale => @locale) do -%>
    <a tabindex="0" href="#search_menu" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="fg_search"><span class="ui-icon ui-icon-triangle-1-s"></span><%= t('page.search') -%></a>
    <div id="search_menu" class="hidden">
      <ul>
        <li><%= link_to t('page.search_resource', :model => t('page.resource')), manifestations_path -%></li>
        <%- if Bookmark.is_indexable_by(current_user) -%>
          <li><%= link_to t('page.search_resource', :model => t('activerecord.models.bookmark')), user_bookmarks_path(current_user.username) -%></li>
        <%- end -%>
        <li><%= link_to t('page.search_resource', :model => t('activerecord.models.question')), questions_path -%></li>
        <li><%= link_to t('page.search_resource', :model => t('activerecord.models.patron')), patrons_path -%></li>
        <%- if User.is_indexable_by(current_user) -%>
          <li><%= link_to t('page.search_resource', :model => t('activerecord.models.user')), users_path -%></li>
        <%- end -%>
        <li><%= link_to t('page.search_resource', :model => t('activerecord.models.subject')), subjects_path -%></li>
      </ul>
    </div>
  <%- end -%>
  <%- cache(:controller => 'page', :user => current_user.try(:username), :menu => 'message', :locale => @locale) do -%>
    <a tabindex="1" href="#message_menu" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="fg_message"><span class="ui-icon ui-icon-triangle-1-s"></span><%= t('activerecord.models.message') -%></a>
    <div id="message_menu" class="hidden">
      <%- if user_signed_in? -%>
        <ul>
          <li><%= link_to t('message.inbox'), user_messages_path(current_user.username) -%></li>
          <%- if current_user.has_role?('Librarian') -%>
            <li><%= link_to t('activerecord.models.message_request'), message_requests_path -%></li>
          <%- end -%>
        </ul>
      <%- else -%>
        <ul>
          <li><%= link_to t('message.inbox'), '/page/message' -%></li>
        </ul>
      <%- end -%>
    </div>
  <%- end -%>
  <a tabindex="2" href="#circulation_menu" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="fg_circulation"><span class="ui-icon ui-icon-triangle-1-s"></span><%= t('page.circulation') -%></a>
  <div id="circulation_menu" class="hidden">
    <%- if user_signed_in? -%>
      <ul>
        <%- if current_user.has_role?('Librarian') -%>
          <li><%= link_to t('page.checkout'), new_basket_path -%></li>
          <li>
            <%- if @checkins and @basket -%>
              <%= link_to t('page.checkin'), user_basket_checkins_path(@basket.user.username, @basket) -%>
            <%- else -%>
              <%= link_to t('page.checkin'), checkins_path -%>
            <%- end -%>
          </li>
          <li><%= link_to t('activerecord.models.inter_library_loan'), inter_library_loans_path -%></li>
          <!--
          <li><%= link_to 'NACSIS ILL', '/page/under_construction' -%></li>
          -->
        <%- end -%>
        <li><%= link_to t('page.checkout_history'), user_checkouts_path(current_user.username) -%></li>
      </ul>
    <%- else -%>
      <ul>
        <li><%= link_to t('page.checkout_history'), checkouts_path -%></li>
      </ul>
    <%- end -%>
  </div>
  <%- if user_signed_in? -%>
    <%- if current_user.has_role?('Librarian') -%>
      <a tabindex="3" href="#acquisition_menu" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="fg_acquisition"><span class="ui-icon ui-icon-triangle-1-s"></span><%= t('page.acquisition') -%></a>
    <%- else -%>
      <a tabindex="3" href="#acquisition_menu" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="fg_acquisition"><span class="ui-icon ui-icon-triangle-1-s"></span><%= t('activerecord.models.bookmark') -%></a>
    <%- end -%>
  <%- else -%>
    <a tabindex="3" href="#acquisition_menu" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="fg_acquisition"><span class="ui-icon ui-icon-triangle-1-s"></span><%= t('activerecord.models.bookmark') -%></a>
  <%- end -%>
  <%- if user_signed_in? -%>
    <div id="acquisition_menu" class="hidden">
      <ul>
        <li><%= link_to t('page.add_manually'), new_import_request_path -%></li>
        <%- if current_user.has_role?('Librarian') -%>
          <li><%= link_to t('page.import_from_file'), '/page/import' -%></li>
          <li><%= link_to t('page.upload_file'), new_manifestation_path(:mode => 'attachment') -%></li>
        <%- end -%>
        <li><%= link_to t('bookmark.add_to_my_bookmark'), new_user_bookmark_path(current_user.username, :url => request.url) -%></li>
      </ul>
    </div>
  <%- else -%>
    <div id="acquisition_menu" class="hidden">
      <ul>
        <li><%= link_to t('page.listing', :model => t('activerecord.models.bookmark')), bookmarks_path -%></li>
      </ul>
    </div>
  <%- end -%>
  <%- cache(:controller => 'page', :user => current_user.try(:username), :menu => 'request', :locale => @locale) do -%>
    <a tabindex="4" href="#request_menu" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="fg_request"><span class="ui-icon ui-icon-triangle-1-s"></span><%= t('page.request') -%></a>
    <%- if user_signed_in? -%>
      <div id="request_menu" class="hidden">
        <ul>
          <li>
            <%- if current_user.has_role?('Librarian') -%>
              <%= link_to t('activerecord.models.reserve'), reserves_path -%>
            <%- else -%>
              <%= link_to t('activerecord.models.reserve'), user_reserves_path(current_user.username) -%>
            <%- end -%>
          </li>
          <li><%= link_to t('activerecord.models.purchase_request'), user_purchase_requests_path(current_user.username) -%></li>
          <li><%= link_to t('activerecord.models.question'), user_questions_path(current_user.username) -%></li>
        </ul>
      </div>
    <%- else -%>
      <div id="request_menu" class="hidden">
        <ul>
          <li><%= link_to t('activerecord.models.reserve'), reserves_path -%></li>
          <li><%= link_to t('activerecord.models.purchase_request'), purchase_requests_path -%></li>
          <li><%= link_to t('activerecord.models.question'), questions_path -%></li>
        </ul>
      </div>
    <%- end -%>
  <%- end -%>
  <a tabindex="5" href="#event_menu" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="fg_event"><span class="ui-icon ui-icon-triangle-1-s"></span><%= t('activerecord.models.event') -%></a>
  <div id="event_menu" class="hidden">
    <%- if @library_group -%>
      <%- unless @library_group.physical_libraries.blank? -%>
        <ul>
          <li><%= link_to t('page.calendar'), '/calendar' -%></li>
          <li><%= link_to t('event.all'), events_path -%></li>
          <%- @library_group.physical_libraries.each do |library| -%>
            <li><%= link_to h(library.display_name.localize), library_events_path(library.name) -%></li>
          <%- end -%>
          <%- if Event.is_creatable_by(current_user) -%>
            <li><%= link_to t('page.import'), new_event_import_file_path -%></li>
          <%- end -%>
        </ul>
      <%- end -%>
    <%- end -%>
  </div>
  <%- cache(:controller => 'page', :user => current_user.try(:username), :menu => 'configuration', :locale => @locale) do -%>
    <a tabindex="6" href="#management_menu" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="fg_management"><span class="ui-icon ui-icon-triangle-1-s"></span><%= t('page.management') -%></a>
    <div id="management_menu" class="hidden">
      <%- if user_signed_in? -%>
        <%- if current_user.has_role?('Librarian') -%>
          <ul>
            <li><%= link_to t('page.new', :model => t('activerecord.models.user')), new_user_path -%></li>
            <li><%= link_to t('page.patron_management'), patrons_path -%></li>
            <li><%= link_to t('page.import'), '/page/import' -%></li>
            <li><%= link_to t('page.export'), '/page/export' -%></li>
            <li><%= link_to t('activerecord.models.order_list'), order_lists_path -%></li>
            <li><%= link_to t('page.statistics'), '/page/statistics' -%></li>
            <li><%= link_to t('activerecord.models.search_history'), search_histories_path -%></li>
            <!--
            <li><%= link_to t('page.recommendation'), '/page/under_construction' -%></li>
            <li><%= link_to 'Send questions and answers to CRD', '/page/under_construction' -%></li>
            -->
            <li><%= link_to t('page.configuration'), '/page/configuration' -%></li>
          </ul>
        <%- else -%>
          <ul>
            <li><%= link_to t('user.account_management'), edit_user_path(current_user.username) -%></li>
          </ul>
        <%- end -%>
      <%- else -%>
        <ul>
          <li><%= link_to t('page.login'), new_user_session_path -%></li>
        </ul>
      <%- end -%>
    </div>
  <%- end -%>
</div>
